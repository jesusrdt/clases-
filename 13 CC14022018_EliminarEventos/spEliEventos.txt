USE SIAccesoTornosDB

GO

ALTER PROCEDURE spEliEventos
AS
BEGIN
	DECLARE @MESES_HIST AS INT, 
			@FECHA_ELIMINAR AS DATETIME,
			@CANT_REGISTROS AS INT,
			@CODIGO_AUDITORIA AS INT
	
	IF EXISTS(SELECT * FROM PARAMETRO WHERE par_Definicion = 'HIST_EVENTOS' AND par_Estatus = 1)
	BEGIN
		IF (SELECT ISNUMERIC(par_Variable2) FROM PARAMETRO WHERE par_Definicion = 'HIST_EVENTOS' AND par_Estatus = 1) = 1
			SELECT @MESES_HIST=ISNULL(CONVERT(INT,par_Variable2),6) FROM PARAMETRO WHERE par_Definicion = 'HIST_EVENTOS' AND par_Estatus = 1
		ELSE
			SET @MESES_HIST = 6
	END
	ELSE
		SET @MESES_HIST = 6

	SELECT @FECHA_ELIMINAR = DATEADD(MONTH,-@MESES_HIST,GETDATE())
	SELECT @CANT_REGISTROS = COUNT(*) FROM EVENTO WHERE EVE_FECHA < @FECHA_ELIMINAR

	IF @CANT_REGISTROS > 0
	BEGIN
		DELETE FROM EVENTO WHERE EVE_FECHA < @FECHA_ELIMINAR
		SELECT @CODIGO_AUDITORIA= ISNULL(MAX(AEV_CODIGO),0) + 1 FROM AUDITORIA_EVENTOS
		INSERT INTO AUDITORIA_EVENTOS VALUES (@CODIGO_AUDITORIA, GETDATE(),@CANT_REGISTROS)
	END

END